<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://example.com/nxrefine_General_Node/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>NxRefine General Node - CHESS ID4B QM2</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "NxRefine General Node";
        var mkdocs_page_input_path = "nxrefine_General_Node.md";
        var mkdocs_page_url = "/nxrefine_General_Node/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-ABC123"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', "G-ABC123");
      </script>
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> CHESS ID4B QM2
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Home</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="..">Welcome</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Beamline information</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../introduction/">Introduction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../publications/">Beamline Publications</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../beamline_parameters/">Beamline USER Guide</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">Sample information</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../sample_env/">Sample environment</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../sample/">Sample mount</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../SPEC_commands/">ID4B-SPEC commands</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../beamline_basics/">Beamline basics</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="#">Sample alignment</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../sample_alignment_HDRM/">HDRM</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../sample_alignment_REXS/">REXS</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../temp/">Temperature switch</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../gas_flow/">Gas flow control</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Data Analysis</a>
    <ul class="current">
                <li class="toctree-l3"><a class="reference internal" href="../ID4B_Codes/">Data processing</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../ID4B_Codes_general_nodes/">General node</a>
                </li>
                <li class="toctree-l3 current"><a class="reference internal current" href="./">NxRefine General Node</a>
    <ul class="current">
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../nxrefine/">NxRefine</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../detailed_dataanalysis/">Detailed Data Analyis</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="#">Data visualization</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../nexpy/">NeXpy</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../pymca/">pyMCA</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">Beamline equipments</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../PTZ_camera/">Cameras</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../diffractometer/">Diffractometer</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../cryocooler/">Cryocooler</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../detector_information/">Detector</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Things to check during beamtime</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../note/">Note</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Troubleshooting</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../IC1_signal/">IC1 signal issues</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../controlC_question/">Control C Questions</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../beam_dump/">Beam dump</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../lost_fourc/">Missing SPEC</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../camera_image_stuck/">Camera image stuck</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../nexpy_crushed/">NexPy crushed</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../lower_diode_signal/">Lower diode signal</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cryo_fail/">Cryostream sudden failure</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../comp_issues/">Computer Issues</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Admin Documentation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../beamline_setup/">Beamline setup</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../Cryostat/">Cryostat</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../energy_change/">Energy change</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../SPEC_macros/">SPEC macro</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Frequently Asked Questions (FAQ)</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../information/">Before coming to the beamline</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../FAQ/">Beamline Frequently Asked Questions</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">About</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../about/">About</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../license/">License</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">CHESS ID4B QM2</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Home</li>
          <li class="breadcrumb-item">Beamline information</li>
          <li class="breadcrumb-item">Data Analysis</li>
      <li class="breadcrumb-item active">NxRefine General Node</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/suchismitasarker/CHESS-ID4B-QM2/blob/main/README.md/edit/master/docs/nxrefine_General_Node.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div><h1 id="nxrefine">NXRefine<a class="headerlink" href="#nxrefine" title="Permanent link">¶</a></h1>
<p>The code is written by Dr. Ray Osborn. More details will be available <a href="https://nexpy.github.io/nxrefine/">NXRefine</a>.The code provides various tools for stacking the raw data, finding Bragg peaks, solving the orientation matrix, and finally providing the HKL. </p>
<h1 id="data-policy">Data Policy<a class="headerlink" href="#data-policy" title="Permanent link">¶</a></h1>
<div class="admonition hint">
<p class="admonition-title">Data policy</p>
<p>We only stored the raw data for six months and processed data for a year. Please process the data and copy it to your server. If you need more time, then consult your beamline scientist.</p>
</div>
<h1 id="nxrefine-general-nodes">NXRefine General Nodes<a class="headerlink" href="#nxrefine-general-nodes" title="Permanent link">¶</a></h1>
<figure>
<p><img alt="Image title" src="https://github.com/suchismitasarker/CHESS-ID4B-QM2/blob/main/pictures/Beamline%20computers.png?raw=true"></p>
</figure>
<p>===============================================================================</p>
<ul>
<li>(i) <b> Step 1 :</b></li>
</ul>
<p><i> Make sure you have permission for the desired folders,  before running the job in the queue, ask your beamline scientist to change the permission of the folder (it is always need to be updated). Also, make sure you have the <i> parent file </i> for each folders, otherwise the code will not work.  </i></p>
<div class="admonition danger">
<p class="admonition-title">Change the &lt; classe_id &gt; to your own CLASSE ID</p>
</div>
<ul>
<li>
<p>(ii) <b> Step 2 :</b> Login to lnx201</p>
<div class="codehilite"><pre><span></span><code>ssh &lt;classe_id&gt;@lnx201.classe.cornell.edu
</code></pre></div>

</li>
<li>
<p>(iii) <b> Step 3 :</b> </p>
<div class="codehilite"><pre><span></span><code>qrsh -q interactive.q -l mem_free=350G -pe sge_pe 20
</code></pre></div>

</li>
<li>
<p>(vi) <b> Step 4 :</b>: Go to the desired data analayis forder (it will your folder in aux)</p>
<div class="codehilite"><pre><span></span><code>cd /nfs/chess/id4baux/2024-1/&lt;BTR-3946-a&gt;/
</code></pre></div>

</li>
<li>
<p>(vi) <b> Step 5 :</b>: 
Changed the desired steps for nxrefine from the folder or if you know how to use vim, then do to change the qsub file and do that necessasy steps </p>
</li>
<li>
<p>Make sure you have change the file path and the threshold of the nxfind of the sample</p>
</li>
<li>
<p>If you are nomachine, you can change the qsub_jobs_****.sh file directly based on the steps you want to perform in the data processing  </p>
<div class="codehilite"><pre><span></span><code>vim qsub_jobs_&lt;name of the user&gt;.sh
</code></pre></div>

</li>
<li>
<p>(vii) <b> Step 6 : </b> Run the job in lnx201 (make sure path is correct)</p>
<div class="codehilite"><pre><span></span><code>qsub -q all.q -l mem_free=350G -pe sge_pe 32 /nfs/chess/id4baux/2025-1/sarker-3946-a/qsub_jobs_&lt;name of the file&gt;.sh
</code></pre></div>

</li>
</ul>
<div class="admonition danger">
<p class="admonition-title">If it did not work, try to use less memory and submit the job again</p>
</div>
<ul>
<li>
<p>You can change mem_free = 200, below is the example</p>
<div class="codehilite"><pre><span></span><code>qsub -q all.q -l mem_free=200G -pe sge_pe 32 /nfs/chess/id4baux/2025-1/sarker-3946-a/qsub_jobs_&lt;name of the file&gt;.sh
</code></pre></div>

</li>
<li>
<p>(viii) <b> Step 9 :</b> Check the status</p>
<div class="codehilite"><pre><span></span><code>qstat
</code></pre></div>

</li>
<li>
<p>(ix) <b> Step 10 :</b> See the status ebaborately</p>
<div class="codehilite"><pre><span></span><code>cat qsub_jobs_&lt;classe_id&gt;.sh.e7231424
</code></pre></div>

</li>
<li>
<p>(x) <b> Step 11 :</b> Finally after you the data procesing</p>
<div class="codehilite"><pre><span></span><code>chmod -R 777 /nfs/chess/id4baux/2025-1/&lt;project_name&gt;

Example:

chmod -R 777 /nfs/chess/id4baux/2025-1/sarker-3490-a
</code></pre></div>

</li>
</ul>
<h2 id="want-to-reprocess-the-data-with-higher-step-size-or-better-resolution">Want to reprocess the data with higher step size or better resolution?<a class="headerlink" href="#want-to-reprocess-the-data-with-higher-step-size-or-better-resolution" title="Permanent link">¶</a></h2>
<div class="admonition hint">
<p class="admonition-title">Reprocessing steps</p>
<p>Once you have received the HKLI data from the QM2 beamline, you can visualize the data. If you want higher resolution in nxrefine trnasform stage and nxcombine you can modify that. Below is the help command to see what paramters you can change in <code>nxtransform</code> and <code>nxcombine</code> stage.</p>
<div class="codehilite"><pre><span></span><code>nxtransform --h
usage: nxtransform [-h] -d DIRECTORY [-e ENTRIES [ENTRIES ...]] [-qh QH QH QH] [-qk QK QK QK] [-ql QL QL QL] [-R] [-M] [-o] [-q]
Perform CCTW transform options:
-h, --help show this help message and exit
-d DIRECTORY, --directory DIRECTORY scan directory
-e ENTRIES [ENTRIES ...], --entries ENTRIES [ENTRIES ...] names of entries to be processed
-qh QH QH QH Qh - min, step, max
-qk QK QK QK Qk - min, step, max
-ql QL QL QL Ql - min, step, max
-R, --regular perform regular transform
-M, --mask perform transform with 3D mask
-o, --overwrite overwrite existing transforms
-q, --queue add to server task queue

nxcombine --h
usage: nxcombine [-h] [-d DIRECTORY] [-e ENTRIES [ENTRIES ...]] [-R] [-M] [-o] [-q]

Combine CCTW transforms

options:
-h, --help            show this help message and exit
-d DIRECTORY, --directory DIRECTORY
                        scan directory
-e ENTRIES [ENTRIES ...], --entries ENTRIES [ENTRIES ...]
                        names of entries to be combined.
-R, --regular         combine transforms
-M, --mask            combine transforms with 3D mask
-o, --overwrite       overwrite existing transform
-q, --queue           add to server task queue
</code></pre></div>

</div>
<p>Now based on the <code>help</code> command, you can modify the script and add the <code>min</code> <code>stepsize</code> <code>max</code> for your desired data. For example, previously your HKLI and step size is below</p>
<figure>
<p><img alt="Image title" src="https://github.com/suchismitasarker/CHESS-ID4B-QM2/blob/main/pictures/transform.png?raw=true" width="450"></p>
</figure>
<p>However, you want to change that. To modify, you go your previous script and add <code>min</code> <code>stepsize</code> <code>max</code> in <code>nxtransform</code>. <br>
I’ve provided an example of the script for general node lnx201. For clarity, I used the full path but you may want to modify it based on your directory structure and desired parameter values. Also, note that instead of using <code>nxreduce</code>, this workflow separates the process into two steps: <code>nxtransform</code> and <code>nxcombine</code>. In both cases, it is important that you <code>overwrite</code> the exsisting data.</p>
<div class="admonition hint">
<p class="admonition-title">Modification of the script</p><div class="codehilite"><pre><span></span><code>    Comment out the below line
    #nxreduce --directory ${USER_DIR}${TEMP} --entries f1 f2 f3 --transform --combine --regular

    Add and modify below 
    nxtransform --directory /nfs/chess/id4baux/2023-3/sarker-3828-a/nxrefine/AB3C5/sample1/16/ --entries f1 f2 f3 -qh -8 0.01 8 -qk -8 0.01 8 -ql -18 0.01 18 --regular --overwrite

    and finally combine
    nxcombine --directory /nfs/chess/id4baux/2023-3/sarker-3828-a/nxrefine/AB3C5/sample1/16/ --entries f1 f2 f3 --regular --overwrite
</code></pre></div>


</div>
<p>After getting the data, visulize the HKLI and once you are satified with the stepsize, you set that as <code>parent file</code> again and reprocess rest of the dataset.</p></div></html>

              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ID4B_Codes_general_nodes/" class="btn btn-neutral float-left" title="General node"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../nxrefine/" class="btn btn-neutral float-right" title="NxRefine">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>© Copyright 2025, CHESS ID4B Beamline</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/suchismitasarker/CHESS-ID4B-QM2/blob/main/README.md" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../ID4B_Codes_general_nodes/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../nxrefine/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
